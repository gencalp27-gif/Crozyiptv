<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Croz IPTV Pro - M3U Güvenli</title>
<style>
:root {
  --bg:#111; --card:#222; --text:#fff; --accent:#e50914;
}
body{font-family:sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:1rem;transition:all 0.3s;}
input,button,select{padding:0.5rem;margin:0.3rem 0;border-radius:5px;border:none;transition:all 0.3s;}
input,select{width:90%;max-width:350px;}
button{background:var(--accent);color:#fff;cursor:pointer;}
#playerContainer{width:90%;max-width:600px;margin-top:1rem;position:relative;}
video{width:100%;border-radius:10px;background:#000;}
#nowPlaying{margin-top:0.5rem;font-size:0.9rem;color:#00d46a;text-align:center;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.3rem;margin-top:1rem;width:90%;}
.card{background:var(--card);padding:0.5rem;border-radius:5px;cursor:pointer;text-align:center;font-size:0.9rem;position:relative;}
.card:hover{background:#333;}
.card.playing{background:var(--accent);color:#fff;}
.message{padding:0.5rem 1rem;border-radius:5px;margin-top:0.5rem;width:90%;max-width:350px;text-align:center;}
.error{background:#e50914;color:#fff;}
.success{background:#00d46a;color:#fff;}
</style>
</head>
<body>

<h2>Croz IPTV Pro - Güvenli M3U</h2>

<input type="url" id="m3uUrl" placeholder="M3U URL girin">
<button id="loadBtn">Kanalları Yükle</button>

<div id="msg"></div>

<div id="playerContainer">
<video id="player" controls></video>
<div id="nowPlaying">Şu an: -</div>
</div>

<div class="grid" id="channelGrid"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const player=document.getElementById('player');
const grid=document.getElementById('channelGrid');
const nowPlaying=document.getElementById('nowPlaying');
const msg=document.getElementById('msg');
let channels=[],filteredChannels=[],currentHls=null,currentIndex=0;

// Göster mesaj
function showMessage(text,type){
  msg.textContent=text;
  msg.className='message '+type;
  setTimeout(()=>{ msg.textContent=''; msg.className=''; },4000);
}

// Load M3U
document.getElementById('loadBtn').addEventListener('click',async()=>{
  const url=document.getElementById('m3uUrl').value.trim();
  if(!url){ showMessage("Lütfen M3U URL girin!","error"); return; }
  showMessage("Yükleniyor...","success");
  try{
    // Güvenli proxy ile fetch
    const proxy="https://corsproxy.io/?"+encodeURIComponent(url);
    const res=await fetch(proxy);
    if(!res.ok) throw new Error("Sunucu hatası: "+res.status);
    const text=await res.text();

    if(!text.includes('#EXTINF:')) throw new Error("Geçerli M3U değil!");

    // Parse
    const lines=text.split('\n');
    channels=[]; let current={};
    lines.forEach(line=>{
      line=line.trim();
      if(line.startsWith('#EXTINF:')){
        const nameMatch=line.match(/,(.*)$/);
        current.name=nameMatch?nameMatch[1]:"Bilinmeyen";
        const lower=current.name.toLowerCase();
        if(lower.includes('film')||lower.includes('movie'))current.category='movie';
        else if(lower.includes('dizi')||lower.includes('series'))current.category='series';
        else if(lower.includes('spor')||lower.includes('sport'))current.category='sport';
        else if(lower.includes('müzik')||lower.includes('music'))current.category='music';
        else current.category='live';
      } else if(line.startsWith('http')){
        current.url=line; channels.push({...current}); current={};
      }
    });

    if(channels.length===0) throw new Error("Kanal bulunamadı!");

    filteredChannels=channels.slice();
    renderChannels();
    showMessage("Kanallar yüklendi!","success");

  }catch(err){
    console.error(err);
    showMessage("M3U yükleme hatası: "+err.message,"error");
  }
});

// Render channels
function renderChannels(){
  grid.innerHTML="";
  filteredChannels.forEach((ch,i)=>{
    const card=document.createElement('div'); card.className='card'; card.innerText=ch.name;
    card.onclick=()=>playChannel(i);
    grid.appendChild(card);
  });
}

// Play channel
function playChannel(index){
  currentIndex=index;
  const channel=filteredChannels[index];
  if(!channel||!channel.url) return;
  if(currentHls){ currentHls.destroy(); currentHls=null; }
  player.src=""; nowPlaying.textContent=`Şu an: ${channel.name}`;
  document.querySelectorAll('.card').forEach((c,i)=>c.classList.remove('playing'));
  document.querySelectorAll('.card')[index].classList.add('playing');

  if(Hls.isSupported()){
    currentHls=new Hls();
    currentHls.loadSource(channel.url);
    currentHls.attachMedia(player);
    currentHls.on(Hls.Events.MANIFEST_PARSED,()=>player.play());
  }else if(player.canPlayType('application/vnd.apple.mpegurl')){
    player.src=channel.url; player.play();
  }else{
    showMessage("HLS desteklenmiyor!","error");
  }

  player.onended=()=>{ currentIndex++; if(currentIndex<filteredChannels.length) playChannel(currentIndex); }
}
</script>

</body>
</html>